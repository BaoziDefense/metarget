# Linux内核提权漏洞CVE-2018-18955

## 场景介绍

由于在`map_write()`中存在逻辑漏洞，攻击者可以通过构造恶意payload，在一些场景下，绕过权限检查达到root权限的能力。

由于需要创建namespace，所以漏洞利用受到seccomp和Capabilities的限制。该漏洞只能在禁用seccomp、以及在获得`CAP_SYS_ADMIN`的情况下利用。

## 漏洞详情

`map_write()`函数中调用`map_id_range_down`的for循环中，更新了`e->lower_first`的值，而e是通过forward来找到的，所以说最终只是更新了forward中的值，而**reverse中的值没有被更改**，

所以说这个reverse中的值是用户传进来的，如果先有一个名称空间n1，映射自己的root进程到kernel的普通进程，然后n1再创建一个名称空间n2，而将n1的root权限映射到n2的root权限，这样在n2中的`uid_map`中，forword指向的`uid_gid_extent`的第2项被更改了，但是forword指向的没有被更改，还保持root到root的映射，所以**通过这个reverse来判断的uid就会出现权限提升了**。


### 背景知识
#### newuidmap命令
设置`/proc/[pid]/uid_map`，其设置会受到`/etc/subuid`文件的制约，root用户也不能绕过`/etc/subuid`的检查。

> newuidmap verifies that the caller is the owner of the process indicated by pid and that for each of the above sets, each of the UIDs in the range `[loweruid, loweruid+count)` is allowed to the caller according to `/etc/subuid` before setting `/proc/[pid]/uid_map`.


`/etc/subuid`文件每行包含一个用户名和一个user id的可用范围，文件指示了普通用户在newuidmap命令中，配置user namespace的uid映射，可用的user ID。

## 环境搭建

```
sudo ./metarget cnv install cve-2018-18955 --verbose
```

## 漏洞复现

### 本地提权

```
gcc -o subuid_shell subuid_shell.c
gcc -o subshell subshell.c
```

```
./subuid_shell
./subshell
cat /etc/shadow
```

### 容器提权

**Dockerfile**
```Dockerfile
FROM ubuntu

RUN apt-get update && apt-get install uidmap -y
RUN useradd -u 1001 poc
COPY subshell /
COPY subuid_shell /

USER 1001

CMD /bin/bash
```

poc需要用到newuidmap，所以需要安装uidmap

```
docker build -t pod .
docker run -it --rm --security-opt seccomp=unconfined --cap-add sys_admin poc
```
docker 的 seccomp 配置文件默认过滤了unshare系统调用，同时需要CAP_SYS_ADMIN Capabilities。

**容器中**
```
./subuid_shell
./subshell
cat /etc/shadow
```

- 漏洞的本质是在一定场景下可以绕过权限检查，可以以root权限执行一定的操作（这些操作仍然会受到其他安全机制的限制），不等于拥有root权限；
- 没有逃逸出namespace的限制

## 参考文献
- [CVE-2018-18955：较新Linux内核的提权神洞分析](https://www.freebuf.com/vuls/197122.html)